default:
  image: python:3.10
  before_script:
    - pip install -U pip

stages:
  - test
  - build

.base_test:
  stage: test
  script:
    - pip install -U tox
    - tox -e py

test:
  image: python:${PYTHONVERSION}
  parallel:
    matrix:
      - PYTHONVERSION:
          - "3.10"
          - "3.11"
  extends:
    - .base_test

test:lint:
  stage: test
  script:
    - pip install -U tox
    - tox -e isort
    - tox -e pylint

build:image:
  image: quay.io/buildah/stable
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "main" &&
        $CI_PROJECT_NAME == "crawlerstack-spiderkeeper"  &&
        $CI_PROJECT_NAMESPACE == "zncdata/develop/crawlerstack"  &&
        $REGISTRY_USER  &&
        $REGISTRY_PASSWORD
      when: on_success
  variables:
    STORAGE_DRIVER: vfs
    BUILDAH_FORMAT: docker
    BUILDAH_ISOLATION: chroot

  before_script:
    - export IMAGE_NAME=zncdata/crawlerstack-spiderkeeper
    - export VERSION=v4.0.0
    - export VERIFY_REGISTRY=false
    - export REGISTRY=docker-private.zncdata.net
    - export TAG=${IMAGE_NAME}:${VERSION}
    - echo $REGISTRY
    - echo $VERIFY_REGISTRY
    - echo $REGISTRY_USER
    - echo $REGISTRY_PASSWORD
    - echo $TAG
    - buildah info
    - echo "$REGISTRY_PASSWORD" | buildah login --tls-verify=${VERIFY_REGISTRY} -u "$REGISTRY_USER" --password-stdin ${REGISTRY}

  script:
    - buildah build --jobs=2 --tls-verify=${VERIFY_REGISTRY} --platform=linux/arm64,linux/amd64 --manifest="$TAG" .
    - buildah images
    - buildah manifest inspect "$TAG"
    - buildah manifest push --all --tls-verify=${VERIFY_REGISTRY} $TAG docker://${REGISTRY}/${TAG}
