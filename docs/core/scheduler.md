# 调度器

调度器作为采集平台最核心的一部分，任务调度、任务的生命周期管理、执行器的状态管理是调度器的核心内容。

## 流程

### 任务触发流程

1. 添加调度作业
2. 定时/即时作业触发时
    - 选取符合条件的执行器
    - 检验同作业进行中任务数量
3. 任务触发

### 后台检测流程

1. 活跃执行器资源收集
2. 完成的任务，状态回写，清理执行器结束的任务
3. 进行中的任务，等待下次任务检测

## 任务调度

选用 `python` 三方库中较为成熟的 [apscheduler](https://apscheduler.readthedocs.io/) 作为调度包，同时进行调度数据的持久化，
确保调度服务的可靠性。

其中，任务调度分为两类：

- 定时任务调度
    - 按照预定义 `cron` 表达式，特定的时间点或时间范围内触发任务
- 即时任务调度
    - 直接调度，立即触发任务

相同作业，同一时间进行中的任务有最大个数限制，用户可通过 `MAX_ACTIVE_TASK_COUNT` 参数完成修改。

## 任务生命周期管理

任务触发后，调度器定期收集调度任务的状态，及时对已完成的任务做状态更新和清理工作，释放执行器资源，便于后续任务的调度。

## 执行器状态管理

执行器完成注册后，定期完成心跳上报，超出心跳超时时间 `HEARTBEAT_INTERVAL` * 3，此执行器不可用，任务调度切换。
